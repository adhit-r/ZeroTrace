/**
 * Vulnerability store with optimistic updates
 * Uses Zustand selectors for performance
 */
import { create } from 'zustand';
import { devtools } from 'zustand/middleware';

export interface Vulnerability {
  id: string;
  cve_id: string;
  severity: 'critical' | 'high' | 'medium' | 'low';
  title: string;
  description: string;
  cvss_score: number;
  status: 'open' | 'in_progress' | 'resolved' | 'false_positive';
  created_at: string;
  updated_at: string;
}

interface VulnerabilityState {
  vulnerabilities: Vulnerability[];
  selectedVulnerability: Vulnerability | null;
  filters: {
    severity: string[];
    status: string[];
    search: string;
  };
  pagination: {
    page: number;
    pageSize: number;
    total: number;
  };
  
  // Actions
  setVulnerabilities: (vulnerabilities: Vulnerability[]) => void;
  addVulnerability: (vulnerability: Vulnerability) => void;
  updateVulnerability: (id: string, updates: Partial<Vulnerability>) => void;
  deleteVulnerability: (id: string) => void;
  setSelectedVulnerability: (vulnerability: Vulnerability | null) => void;
  setFilters: (filters: Partial<VulnerabilityState['filters']>) => void;
  setPagination: (pagination: Partial<VulnerabilityState['pagination']>) => void;
  
  // Optimistic updates
  optimisticUpdate: (id: string, updates: Partial<Vulnerability>) => void;
  rollbackUpdate: (id: string, original: Vulnerability) => void;
}

export const useVulnerabilityStore = create<VulnerabilityState>()(
  devtools(
    (set, get) => ({
      vulnerabilities: [],
      selectedVulnerability: null,
      filters: {
        severity: [],
        status: [],
        search: '',
      },
      pagination: {
        page: 1,
        pageSize: 25,
        total: 0,
      },
      
      setVulnerabilities: (vulnerabilities) => set({ vulnerabilities }),
      
      addVulnerability: (vulnerability) =>
        set((state) => ({
          vulnerabilities: [vulnerability, ...state.vulnerabilities],
          pagination: { ...state.pagination, total: state.pagination.total + 1 },
        })),
      
      updateVulnerability: (id, updates) =>
        set((state) => ({
          vulnerabilities: state.vulnerabilities.map((v) =>
            v.id === id ? { ...v, ...updates } : v
          ),
          selectedVulnerability:
            state.selectedVulnerability?.id === id
              ? { ...state.selectedVulnerability, ...updates }
              : state.selectedVulnerability,
        })),
      
      deleteVulnerability: (id) =>
        set((state) => ({
          vulnerabilities: state.vulnerabilities.filter((v) => v.id !== id),
          pagination: { ...state.pagination, total: state.pagination.total - 1 },
          selectedVulnerability:
            state.selectedVulnerability?.id === id ? null : state.selectedVulnerability,
        })),
      
      setSelectedVulnerability: (vulnerability) => set({ selectedVulnerability: vulnerability }),
      
      setFilters: (filters) =>
        set((state) => ({
          filters: { ...state.filters, ...filters },
          pagination: { ...state.pagination, page: 1 }, // Reset to first page
        })),
      
      setPagination: (pagination) =>
        set((state) => ({
          pagination: { ...state.pagination, ...pagination },
        })),
      
      // Optimistic update - update UI immediately, rollback on error
      optimisticUpdate: (id, updates) => {
        const original = get().vulnerabilities.find((v) => v.id === id);
        if (original) {
          get().updateVulnerability(id, updates);
          // Store original for potential rollback
          (original as any).__original = original;
        }
      },
      
      rollbackUpdate: (id, original) => {
        get().updateVulnerability(id, original);
      },
    }),
    { name: 'VulnerabilityStore' }
  )
);

// Optimized selectors
export const useVulnerabilities = () =>
  useVulnerabilityStore((state) => state.vulnerabilities);
export const useSelectedVulnerability = () =>
  useVulnerabilityStore((state) => state.selectedVulnerability);
export const useVulnerabilityFilters = () =>
  useVulnerabilityStore((state) => state.filters);
export const useVulnerabilityPagination = () =>
  useVulnerabilityStore((state) => state.pagination);

