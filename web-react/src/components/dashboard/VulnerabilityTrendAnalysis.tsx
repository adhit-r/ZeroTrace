import React, { useState, useEffect } from 'react';
import {
  TrendingUp,
  TrendingDown,
  AlertTriangle,
  Shield,
  BarChart3,
  LineChart,
  PieChart,
  Activity,
  Target,
  Eye,
  RefreshCw,
  Flame
} from 'lucide-react';
import type { VulnerabilityTrend, RiskScore, VulnerabilityPattern } from '../../services/dashboardService';
import { vulnerabilityService } from '../../services/vulnerabilityService';
import { agentService } from '../../services/agentService';

// VulnerabilityTrend, RiskScore, and VulnerabilityPattern interfaces are now imported from dashboardService

interface TrendAnalysisData {
  trends: VulnerabilityTrend[];
  riskScores: RiskScore[];
  patterns: VulnerabilityPattern[];
  summary: {
    totalVulnerabilities: number;
    criticalCount: number;
    highCount: number;
    mediumCount: number;
    lowCount: number;
    resolvedCount: number;
    newCount: number;
    exploitedCount: number;
    avgRiskScore: number;
    topRiskyAssets: number;
    complianceScore: number;
  };
  timeRange: {
    start: string;
    end: string;
    period: string;
  };
}

interface VulnerabilityTrendAnalysisProps {
  className?: string;
}

const VulnerabilityTrendAnalysis: React.FC<VulnerabilityTrendAnalysisProps> = ({ className = '' }) => {
  const [data, setData] = useState<TrendAnalysisData | null>(null);
  const [loading, setLoading] = useState(true);
  const [timeRange, setTimeRange] = useState<'7d' | '30d' | '90d' | '1y'>('30d');
  const [viewMode, setViewMode] = useState<'overview' | 'trends' | 'risks' | 'patterns'>('overview');

  useEffect(() => {
    const fetchTrendData = async () => {
      setLoading(true);
      try {
        // Fetch vulnerability and agent data
        const [vulnerabilities, agents] = await Promise.all([
          vulnerabilityService.getVulnerabilities(),
          agentService.getAgents()
        ]);

        // Generate trend data (simulated for demo)
        const trends = generateTrendData(timeRange);
        const riskScores = generateRiskScores(agents);
        const patterns = generateVulnerabilityPatterns();

        const summary = {
          totalVulnerabilities: vulnerabilities.length,
          criticalCount: vulnerabilities.filter((v: any) => v.severity === 'critical').length,
          highCount: vulnerabilities.filter((v: any) => v.severity === 'high').length,
          mediumCount: vulnerabilities.filter((v: any) => v.severity === 'medium').length,
          lowCount: vulnerabilities.filter((v: any) => v.severity === 'low').length,
          resolvedCount: Math.floor(vulnerabilities.length * 0.3),
          newCount: Math.floor(vulnerabilities.length * 0.1),
          exploitedCount: Math.floor(vulnerabilities.length * 0.05),
          avgRiskScore: agents.reduce((sum: number, a: any) => sum + (a.risk_score || 0), 0) / agents.length,
          topRiskyAssets: agents.filter((a: any) => (a.risk_score || 0) >= 70).length,
          complianceScore: Math.max(0, Math.min(100, 100 - (vulnerabilities.length * 2)))
        };

        setData({
          trends,
          riskScores,
          patterns,
          summary,
          timeRange: {
            start: new Date(Date.now() - getTimeRangeMs(timeRange)).toISOString(),
            end: new Date().toISOString(),
            period: timeRange
          }
        });
      } catch (error) {
        console.error('Failed to fetch trend data:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchTrendData();
  }, [timeRange]);

  const getTimeRangeMs = (range: string): number => {
    switch (range) {
      case '7d': return 7 * 24 * 60 * 60 * 1000;
      case '30d': return 30 * 24 * 60 * 60 * 1000;
      case '90d': return 90 * 24 * 60 * 60 * 1000;
      case '1y': return 365 * 24 * 60 * 60 * 1000;
      default: return 30 * 24 * 60 * 60 * 1000;
    }
  };

  const generateTrendData = (range: string): VulnerabilityTrend[] => {
    const days = range === '7d' ? 7 : range === '30d' ? 30 : range === '90d' ? 90 : 365;
    const trends: VulnerabilityTrend[] = [];

    for (let i = days - 1; i >= 0; i--) {
      const date = new Date(Date.now() - i * 24 * 60 * 60 * 1000);
      const baseCount = Math.floor(Math.random() * 20) + 10;

      trends.push({
        date: date.toISOString().split('T')[0],
        total: baseCount,
        critical: Math.floor(baseCount * 0.1),
        high: Math.floor(baseCount * 0.2),
        medium: Math.floor(baseCount * 0.4),
        low: Math.floor(baseCount * 0.3),
        resolved: Math.floor(baseCount * 0.2),
        new: Math.floor(baseCount * 0.1),
        exploited: Math.floor(baseCount * 0.05)
      });
    }

    return trends;
  };

  const generateRiskScores = (agents: any[]): RiskScore[] => {
    return agents.map(agent => ({
      assetId: agent.id,
      hostname: agent.hostname || 'Unknown',
      score: agent.risk_score || Math.floor(Math.random() * 100),
      factors: [
        { name: 'Vulnerabilities', weight: 0.4, score: Math.floor(Math.random() * 100), impact: 'high' as const },
        { name: 'Compliance', weight: 0.3, score: Math.floor(Math.random() * 100), impact: 'medium' as const },
        { name: 'Configuration', weight: 0.2, score: Math.floor(Math.random() * 100), impact: 'medium' as const },
        { name: 'Network', weight: 0.1, score: Math.floor(Math.random() * 100), impact: 'low' as const }
      ],
      trend: Math.random() > 0.5 ? 'increasing' : 'decreasing',
      lastUpdated: agent.last_seen || new Date().toISOString()
    }));
  };

  const generateVulnerabilityPatterns = (): VulnerabilityPattern[] => {
    return [
      {
        type: 'SQL Injection',
        frequency: 15,
        severity: 'critical',
        affectedAssets: 8,
        commonCauses: ['Unvalidated input', 'Dynamic queries', 'Error messages'],
        mitigation: ['Input validation', 'Parameterized queries', 'Error handling']
      },
      {
        type: 'Cross-Site Scripting (XSS)',
        frequency: 12,
        severity: 'high',
        affectedAssets: 6,
        commonCauses: ['Unescaped output', 'DOM manipulation', 'Event handlers'],
        mitigation: ['Output encoding', 'CSP headers', 'Input sanitization']
      },
      {
        type: 'Buffer Overflow',
        frequency: 8,
        severity: 'critical',
        affectedAssets: 4,
        commonCauses: ['Unbounded copying', 'Integer overflow', 'Stack corruption'],
        mitigation: ['Bounds checking', 'Safe functions', 'Stack protection']
      }
    ];
  };

  const getRiskColor = (score: number) => {
    if (score >= 80) return 'text-red-600 bg-red-100';
    if (score >= 60) return 'text-orange-600 bg-orange-100';
    if (score >= 40) return 'text-yellow-600 bg-yellow-100';
    return 'text-green-600 bg-green-100';
  };

  const getSeverityColor = (severity: string) => {
    switch (severity) {
      case 'critical': return 'text-red-600 bg-red-100';
      case 'high': return 'text-orange-600 bg-orange-100';
      case 'medium': return 'text-yellow-600 bg-yellow-100';
      case 'low': return 'text-green-600 bg-green-100';
      default: return 'text-gray-600 bg-gray-100';
    }
  };

  const getTrendIcon = (trend: string) => {
    switch (trend) {
      case 'increasing': return <TrendingUp className="h-4 w-4 text-red-600" />;
      case 'decreasing': return <TrendingDown className="h-4 w-4 text-green-600" />;
      default: return <Activity className="h-4 w-4 text-gray-600" />;
    }
  };

  if (loading) {
    return (
      <div className={`p-6 ${className}`}>
        <div className="flex items-center justify-center h-64">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
        </div>
      </div>
    );
  }

  if (!data) {
    return (
      <div className={`p-6 ${className}`}>
        <div className="text-center text-gray-500">
          <BarChart3 className="h-12 w-12 mx-auto mb-4" />
          <p>No trend data available</p>
        </div>
      </div>
    );
  }

  return (
    <div className={`space-y-6 ${className}`}>
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h2 className="text-2xl font-bold text-gray-900">Vulnerability Trend Analysis</h2>
          <p className="text-gray-600">Comprehensive security insights and risk assessment</p>
        </div>
        <div className="flex items-center gap-2">
          <select
            value={timeRange}
            onChange={(e) => setTimeRange(e.target.value as any)}
            className="px-4 py-2 border-2 border-black rounded focus:outline-none"
          >
            <option value="7d">Last 7 Days</option>
            <option value="30d">Last 30 Days</option>
            <option value="90d">Last 90 Days</option>
            <option value="1y">Last Year</option>
          </select>
          <button className="p-2 bg-blue-600 text-white rounded border-2 border-blue-700 hover:bg-blue-700 transition-colors">
            <RefreshCw className="h-4 w-4" />
          </button>
        </div>
      </div>

      {/* View Mode Tabs */}
      <div className="flex space-x-1 bg-gray-100 p-1 rounded-lg">
        {[
          { id: 'overview', label: 'Overview', icon: BarChart3 },
          { id: 'trends', label: 'Trends', icon: LineChart },
          { id: 'risks', label: 'Risk Scores', icon: Target },
          { id: 'patterns', label: 'Patterns', icon: PieChart }
        ].map((tab) => (
          <button
            key={tab.id}
            onClick={() => setViewMode(tab.id as any)}
            className={`flex items-center gap-2 px-4 py-2 rounded-md transition-colors ${viewMode === tab.id
              ? 'bg-white text-blue-600 shadow-sm'
              : 'text-gray-600 hover:text-gray-900'
              }`}
          >
            <tab.icon className="h-4 w-4" />
            {tab.label}
          </button>
        ))}
      </div>

      {/* Overview Mode */}
      {viewMode === 'overview' && (
        <div className="space-y-6">
          {/* Summary Cards */}
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div className="p-6 bg-white border-3 border-black rounded shadow-lg">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-gray-600">Total Vulnerabilities</p>
                  <p className="text-3xl font-bold text-red-600">{data.summary.totalVulnerabilities}</p>
                  <p className="text-sm text-gray-600">{data.summary.newCount} new this period</p>
                </div>
                <AlertTriangle className="h-12 w-12 text-red-600" />
              </div>
            </div>

            <div className="p-6 bg-white border-3 border-black rounded shadow-lg">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-gray-600">Critical Issues</p>
                  <p className="text-3xl font-bold text-red-600">{data.summary.criticalCount}</p>
                  <p className="text-sm text-red-600">{data.summary.exploitedCount} exploited</p>
                </div>
                <Flame className="h-12 w-12 text-red-600" />
              </div>
            </div>

            <div className="p-6 bg-white border-3 border-black rounded shadow-lg">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-gray-600">Avg Risk Score</p>
                  <p className="text-3xl font-bold text-orange-600">{data.summary.avgRiskScore.toFixed(1)}%</p>
                  <p className="text-sm text-orange-600">{data.summary.topRiskyAssets} high-risk assets</p>
                </div>
                <Target className="h-12 w-12 text-orange-600" />
              </div>
            </div>

            <div className="p-6 bg-white border-3 border-black rounded shadow-lg">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-gray-600">Compliance Score</p>
                  <p className="text-3xl font-bold text-green-600">{data.summary.complianceScore}%</p>
                  <p className="text-sm text-green-600">{data.summary.resolvedCount} resolved</p>
                </div>
                <Shield className="h-12 w-12 text-green-600" />
              </div>
            </div>
          </div>

          {/* Vulnerability Distribution */}
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div className="p-6 bg-white border-3 border-black rounded shadow-lg">
              <h3 className="text-lg font-bold mb-4">Vulnerability Distribution</h3>
              <div className="space-y-4">
                {[
                  { severity: 'Critical', count: data.summary.criticalCount, color: 'bg-red-600' },
                  { severity: 'High', count: data.summary.highCount, color: 'bg-orange-600' },
                  { severity: 'Medium', count: data.summary.mediumCount, color: 'bg-yellow-600' },
                  { severity: 'Low', count: data.summary.lowCount, color: 'bg-green-600' }
                ].map((item) => (
                  <div key={item.severity} className="flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <div className={`w-4 h-4 rounded ${item.color}`}></div>
                      <span className="font-medium">{item.severity}</span>
                    </div>
                    <div className="flex items-center gap-3">
                      <div className="w-32 bg-gray-200 rounded-full h-2">
                        <div
                          className={`h-2 rounded-full ${item.color}`}
                          style={{ width: `${(item.count / data.summary.totalVulnerabilities) * 100}%` }}
                        ></div>
                      </div>
                      <span className="font-bold w-8 text-right">{item.count}</span>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            <div className="p-6 bg-white border-3 border-black rounded shadow-lg">
              <h3 className="text-lg font-bold mb-4">Trend Summary</h3>
              <div className="space-y-4">
                <div className="flex items-center justify-between">
                  <span className="text-gray-600">New Vulnerabilities</span>
                  <div className="flex items-center gap-2">
                    <TrendingUp className="h-4 w-4 text-red-600" />
                    <span className="font-bold text-red-600">+{data.summary.newCount}</span>
                  </div>
                </div>
                <div className="flex items-center justify-between">
                  <span className="text-gray-600">Resolved</span>
                  <div className="flex items-center gap-2">
                    <TrendingDown className="h-4 w-4 text-green-600" />
                    <span className="font-bold text-green-600">-{data.summary.resolvedCount}</span>
                  </div>
                </div>
                <div className="flex items-center justify-between">
                  <span className="text-gray-600">Exploited</span>
                  <div className="flex items-center gap-2">
                    <AlertTriangle className="h-4 w-4 text-red-600" />
                    <span className="font-bold text-red-600">{data.summary.exploitedCount}</span>
                  </div>
                </div>
                <div className="flex items-center justify-between">
                  <span className="text-gray-600">Net Change</span>
                  <div className="flex items-center gap-2">
                    {data.summary.newCount > data.summary.resolvedCount ? (
                      <TrendingUp className="h-4 w-4 text-red-600" />
                    ) : (
                      <TrendingDown className="h-4 w-4 text-green-600" />
                    )}
                    <span className={`font-bold ${data.summary.newCount > data.summary.resolvedCount ? 'text-red-600' : 'text-green-600'
                      }`}>
                      {data.summary.newCount - data.summary.resolvedCount > 0 ? '+' : ''}
                      {data.summary.newCount - data.summary.resolvedCount}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Trends Mode */}
      {viewMode === 'trends' && (
        <div className="space-y-6">
          <div className="p-6 bg-white border-3 border-black rounded shadow-lg">
            <h3 className="text-lg font-bold mb-4">Vulnerability Trends Over Time</h3>
            <div className="space-y-4">
              {data.trends.slice(-7).map((trend, index) => (
                <div key={index} className="flex items-center justify-between p-3 bg-gray-50 rounded border-2 border-gray-200">
                  <div className="flex items-center gap-4">
                    <div className="text-sm font-medium">{new Date(trend.date).toLocaleDateString()}</div>
                    <div className="flex items-center gap-2">
                      <span className="text-sm text-gray-600">Total:</span>
                      <span className="font-bold">{trend.total}</span>
                    </div>
                  </div>
                  <div className="flex items-center gap-4">
                    <div className="flex items-center gap-1">
                      <div className="w-3 h-3 bg-red-600 rounded"></div>
                      <span className="text-sm">{trend.critical}</span>
                    </div>
                    <div className="flex items-center gap-1">
                      <div className="w-3 h-3 bg-orange-600 rounded"></div>
                      <span className="text-sm">{trend.high}</span>
                    </div>
                    <div className="flex items-center gap-1">
                      <div className="w-3 h-3 bg-yellow-600 rounded"></div>
                      <span className="text-sm">{trend.medium}</span>
                    </div>
                    <div className="flex items-center gap-1">
                      <div className="w-3 h-3 bg-green-600 rounded"></div>
                      <span className="text-sm">{trend.low}</span>
                    </div>
                    <div className="flex items-center gap-2">
                      <span className="text-sm text-green-600">Resolved: {trend.resolved}</span>
                      <span className="text-sm text-red-600">New: {trend.new}</span>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      )}

      {/* Risk Scores Mode */}
      {viewMode === 'risks' && (
        <div className="space-y-6">
          <div className="p-6 bg-white border-3 border-black rounded shadow-lg">
            <h3 className="text-lg font-bold mb-4">Asset Risk Scores</h3>
            <div className="space-y-3">
              {data.riskScores.slice(0, 10).map((risk, index) => (
                <div key={index} className="flex items-center justify-between p-3 bg-gray-50 rounded border-2 border-gray-200">
                  <div className="flex items-center gap-4">
                    <div>
                      <p className="font-medium">{risk.hostname}</p>
                      <p className="text-sm text-gray-600">Last updated: {new Date(risk.lastUpdated).toLocaleDateString()}</p>
                    </div>
                  </div>
                  <div className="flex items-center gap-4">
                    <div className="text-right">
                      <p className={`px-3 py-1 rounded text-sm font-bold ${getRiskColor(risk.score)}`}>
                        {risk.score}%
                      </p>
                      <div className="flex items-center gap-1 mt-1">
                        {getTrendIcon(risk.trend)}
                        <span className="text-xs text-gray-600 capitalize">{risk.trend}</span>
                      </div>
                    </div>
                    <button className="p-2 text-blue-600 hover:bg-blue-100 rounded">
                      <Eye className="h-4 w-4" />
                    </button>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      )}

      {/* Patterns Mode */}
      {viewMode === 'patterns' && (
        <div className="space-y-6">
          <div className="p-6 bg-white border-3 border-black rounded shadow-lg">
            <h3 className="text-lg font-bold mb-4">Vulnerability Patterns</h3>
            <div className="space-y-4">
              {data.patterns.map((pattern, index) => (
                <div key={index} className="p-4 bg-gray-50 rounded border-2 border-gray-200">
                  <div className="flex items-start justify-between mb-3">
                    <div>
                      <h4 className="font-bold text-lg">{pattern.type}</h4>
                      <div className="flex items-center gap-4 mt-1">
                        <span className={`px-2 py-1 rounded text-xs font-bold ${getSeverityColor(pattern.severity)}`}>
                          {pattern.severity.toUpperCase()}
                        </span>
                        <span className="text-sm text-gray-600">Frequency: {pattern.frequency}</span>
                        <span className="text-sm text-gray-600">Affected: {pattern.affectedAssets} assets</span>
                      </div>
                    </div>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <h5 className="font-medium text-sm text-gray-700 mb-2">Common Causes</h5>
                      <ul className="text-sm text-gray-600 space-y-1">
                        {pattern.commonCauses.map((cause, i) => (
                          <li key={i} className="flex items-center gap-2">
                            <div className="w-1 h-1 bg-gray-400 rounded-full"></div>
                            {cause}
                          </li>
                        ))}
                      </ul>
                    </div>
                    <div>
                      <h5 className="font-medium text-sm text-gray-700 mb-2">Mitigation Strategies</h5>
                      <ul className="text-sm text-gray-600 space-y-1">
                        {pattern.mitigation.map((mit, i) => (
                          <li key={i} className="flex items-center gap-2">
                            <div className="w-1 h-1 bg-green-400 rounded-full"></div>
                            {mit}
                          </li>
                        ))}
                      </ul>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default VulnerabilityTrendAnalysis;
