
import React, { useState } from 'react';
import {
    Shield,
    Zap,
    Filter,
    Database,
    Globe,
    Layout,
    Chrome,
    AlertTriangle,
    CheckCircle,
    Play,
    Lock
} from 'lucide-react';
import type { Agent } from '../../services/agentService';
import { enrichmentService } from '../../services/enrichmentService';
import type { Vulnerability } from '../../services/enrichmentService';

interface VulnerabilityScannerProps {
    agents: Agent[];
}

type ScanScope = 'quick' | 'standard' | 'priority' | 'full';

const VulnerabilityScanner: React.FC<VulnerabilityScannerProps> = ({ agents }) => {
    const [scope, setScope] = useState<ScanScope>('standard');
    const [isScanning, setIsScanning] = useState(false);
    const [progress, setProgress] = useState(0);
    const [status, setStatus] = useState('');
    const [scanStats, setScanStats] = useState({ scanned: 0, total: 0, vulns: 0 });
    const [results, setResults] = useState<Array<Vulnerability & { software: string; agent: string }>>([]);

    const [categories, setCategories] = useState<string[]>([
        'database', 'webserver', 'runtime', 'crypto', 'framework', 'browser'
    ]);

    const toggleCategory = (cat: string) => {
        setCategories(prev =>
            prev.includes(cat) ? prev.filter(c => c !== cat) : [...prev, cat]
        );
    };

    const handleScan = async () => {
        if (agents.length === 0) return;

        setIsScanning(true);
        setProgress(0);
        setResults([]);
        setScanStats({ scanned: 0, total: 0, vulns: 0 });

        try {
            // 1. Collect all software from all agents
            setStatus('Aggregating software inventory...');
            setProgress(5);

            let allSoftware: any[] = [];
            agents.forEach(agent => {
                const deps = agent.metadata?.dependencies || [];
                deps.forEach((d: any) => {
                    allSoftware.push({ ...d, _agent: agent.name });
                });
            });

            if (allSoftware.length === 0) {
                setStatus('No software found to scan.');
                setIsScanning(false);
                return;
            }

            // 2. Filter based on scope
            const filteredSoftware = enrichmentService.filterSoftware(allSoftware, scope, categories);
            setScanStats(prev => ({ ...prev, total: filteredSoftware.length }));

            setStatus(`Preparing to scan ${filteredSoftware.length} packages...`);
            setProgress(10);

            // 3. Enrich in batches
            const BATCH_SIZE = 10;
            let scannedCount = 0;
            let foundVulns: Array<Vulnerability & { software: string; agent: string }> = [];

            for (let i = 0; i < filteredSoftware.length; i += BATCH_SIZE) {
                const batch = filteredSoftware.slice(i, i + BATCH_SIZE);

                try {
                    const enrichedBatch = await enrichmentService.enrichSoftware(batch);

                    scannedCount += batch.length;

                    // Process results
                    enrichedBatch.forEach(sw => {
                        if (sw.vulnerabilities && sw.vulnerabilities.length > 0) {
                            sw.vulnerabilities.forEach(v => {
                                foundVulns.push({
                                    ...v,
                                    software: `${sw.name} ${sw.version}`,
                                    agent: (sw as any)._agent || 'Unknown Agent'
                                });
                            });
                        }
                    });

                    // Update stats
                    setScanStats({
                        scanned: scannedCount,
                        total: filteredSoftware.length,
                        vulns: foundVulns.length
                    });

                    // Update progress
                    const pct = 10 + Math.floor((scannedCount / filteredSoftware.length) * 90);
                    setProgress(pct);
                    setStatus(`Scanning batch ${Math.ceil(scannedCount / BATCH_SIZE)}...`);

                    // Partial results update
                    setResults([...foundVulns]); // clone to trigger re-render

                } catch (e) {
                    console.error('Batch failed', e);
                }
            }

            setStatus('Scan complete.');
            setProgress(100);

        } catch (error) {
            console.error('Scan failed', error);
            setStatus('Scan failed: ' + (error as Error).message);
        } finally {
            setIsScanning(false);
        }
    };

    const getSeverityColor = (severity: string) => {
        switch (severity.toLowerCase()) {
            case 'critical': return 'text-red-500 bg-red-100 border-red-200';
            case 'high': return 'text-orange-500 bg-orange-100 border-orange-200';
            case 'medium': return 'text-yellow-600 bg-yellow-100 border-yellow-200';
            case 'low': return 'text-blue-500 bg-blue-100 border-blue-200';
            default: return 'text-gray-500 bg-gray-100 border-gray-200';
        }
    };

    return (
        <div className="bg-white border border-gray-200 shadow-[4px_4px_0px_0px_rgba(0,0,0,0.1)] mb-8">
            {/* Header */}
            <div className="p-6 border-b border-gray-200 bg-gray-50 flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div>
                    <h2 className="text-xl font-bold text-gray-900 flex items-center gap-2">
                        <Shield className="w-6 h-6 text-indigo-600" />
                        Vulnerability Scanner
                        <span className="text-xs font-mono font-normal text-gray-500 bg-gray-200 px-2 py-1 rounded">v2.0</span>
                    </h2>
                    <p className="text-sm text-gray-500 mt-1">
                        Enrichment-powered vulnerability detection with smart filtering
                    </p>
                </div>

                <div className="flex items-center gap-4">
                    <div className="flex items-center gap-2 bg-white px-3 py-2 border border-gray-200 rounded-md">
                        <Filter className="w-4 h-4 text-gray-400" />
                        <select
                            value={scope}
                            onChange={(e) => setScope(e.target.value as ScanScope)}
                            className="text-sm font-medium text-gray-700 bg-transparent border-none focus:ring-0 cursor-pointer"
                            disabled={isScanning}
                        >
                            <option value="quick">Quick Scan (Top 50)</option>
                            <option value="standard">Standard (Top 200)</option>
                            <option value="priority">Priority Apps Only</option>
                            <option value="full">Full Scan (Limit 1000)</option>
                        </select>
                    </div>

                    <button
                        onClick={handleScan}
                        disabled={isScanning || agents.length === 0}
                        className={`
              flex items-center gap-2 px-6 py-2.5 font-bold text-white transition-all
              ${isScanning
                                ? 'bg-gray-400 cursor-not-allowed'
                                : 'bg-indigo-600 hover:bg-indigo-700 hover:shadow-lg active:translate-y-0.5'}
            `}
                    >
                        {isScanning ? (
                            <>
                                <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin" />
                                Scanning...
                            </>
                        ) : (
                            <>
                                <Play className="w-4 h-4 fill-current" />
                                Run Scan
                            </>
                        )}
                    </button>
                </div>
            </div>

            {/* Configuration & Status */}
            <div className="p-6">
                {/* Category Toggles */}
                <div className="mb-6">
                    <label className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3 block">
                        Priority Categories
                    </label>
                    <div className="flex flex-wrap gap-2">
                        {[
                            { id: 'database', icon: Database, label: 'Databases' },
                            { id: 'webserver', icon: Globe, label: 'Web Servers' },
                            { id: 'runtime', icon: Zap, label: 'Runtimes' },
                            { id: 'crypto', icon: Lock, label: 'Crypto/SSL' },
                            { id: 'framework', icon: Layout, label: 'Frameworks' },
                            { id: 'browser', icon: Chrome, label: 'Browsers' }
                        ].map(cat => (
                            <button
                                key={cat.id}
                                onClick={() => toggleCategory(cat.id)}
                                disabled={isScanning}
                                className={`
                  flex items-center gap-2 px-3 py-1.5 text-sm font-medium border transition-colors
                  ${categories.includes(cat.id)
                                        ? 'bg-indigo-50 border-indigo-200 text-indigo-700'
                                        : 'bg-white border-gray-200 text-gray-500 hover:border-gray-300'}
                `}
                            >
                                <cat.icon className="w-3.5 h-3.5" />
                                {cat.label}
                            </button>
                        ))}
                    </div>
                </div>

                {/* Progress Bar (Visible when scanning or after scan) */}
                {(isScanning || scanStats.total > 0) && (
                    <div className="bg-gray-50 border border-gray-100 rounded-lg p-4 mb-6">
                        <div className="flex items-center justify-between mb-2">
                            <span className="text-sm font-medium text-gray-700 animate-pulse">
                                {status}
                            </span>
                            <span className="text-sm font-bold text-indigo-600">
                                {progress}%
                            </span>
                        </div>

                        <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
                            <div
                                className="h-full bg-gradient-to-r from-indigo-500 to-purple-600 transition-all duration-300 ease-out"
                                style={{ width: `${progress}%` }}
                            />
                        </div>

                        <div className="flex justify-between mt-3 text-xs text-gray-500 font-mono">
                            <span>Scanned: {scanStats.scanned} / {scanStats.total}</span>
                            <span className={`${scanStats.vulns > 0 ? 'text-red-600 font-bold' : ''}`}>
                                Vulnerabilities Found: {scanStats.vulns}
                            </span>
                        </div>
                    </div>
                )}

                {/* Results Table */}
                {results.length > 0 && (
                    <div className="overflow-x-auto border border-gray-200">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-gray-50 text-xs uppercase text-gray-500 font-bold border-b border-gray-200">
                                <tr>
                                    <th className="px-4 py-3">Severity</th>
                                    <th className="px-4 py-3">CVE ID</th>
                                    <th className="px-4 py-3">Software</th>
                                    <th className="px-4 py-3">Agent</th>
                                    <th className="px-4 py-3 flex items-center gap-1">
                                        Exploit <AlertTriangle className="w-3 h-3" />
                                    </th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                                {results
                                    .sort((a, b) => {
                                        const sevScore = { critical: 4, high: 3, medium: 2, low: 1, unknown: 0 };
                                        return (sevScore[b.severity] || 0) - (sevScore[a.severity] || 0);
                                    })
                                    .slice(0, 50) // Show top 50
                                    .map((vuln, idx) => (
                                        <tr key={`${vuln.cve_id}-${idx}`} className="hover:bg-gray-50 transition-colors">
                                            <td className="px-4 py-3">
                                                <span className={`px-2 py-1 rounded text-xs font-bold uppercase border ${getSeverityColor(vuln.severity)}`}>
                                                    {vuln.severity}
                                                </span>
                                            </td>
                                            <td className="px-4 py-3 font-mono text-indigo-600 hover:underline">
                                                <a href={`https://nvd.nist.gov/vuln/detail/${vuln.cve_id}`} target="_blank" rel="noopener noreferrer">
                                                    {vuln.cve_id}
                                                </a>
                                            </td>
                                            <td className="px-4 py-3 font-medium text-gray-900">{vuln.software}</td>
                                            <td className="px-4 py-3 text-gray-500">{vuln.agent}</td>
                                            <td className="px-4 py-3">
                                                {vuln.known_exploited ? (
                                                    <span className="flex items-center gap-1 text-red-600 font-bold text-xs uppercase">
                                                        <AlertTriangle className="w-3.5 h-3.5" /> KEV
                                                    </span>
                                                ) : (
                                                    <span className="text-gray-300">-</span>
                                                )}
                                            </td>
                                        </tr>
                                    ))}
                            </tbody>
                        </table>
                        {results.length > 50 && (
                            <div className="p-3 text-center text-xs text-gray-500 border-t border-gray-200">
                                Showing top 50 of {results.length} vulnerabilities
                            </div>
                        )}
                    </div>
                )}

                {results.length === 0 && !isScanning && progress === 100 && (
                    <div className="text-center py-10 bg-green-50 rounded border border-green-100">
                        <CheckCircle className="w-12 h-12 text-green-500 mx-auto mb-3" />
                        <h3 className="text-lg font-bold text-green-800">No Vulnerabilities Found</h3>
                        <p className="text-green-600">Great job! The scan didn't detect any known vulnerabilities in the selected scope.</p>
                    </div>
                )}
            </div>
        </div>
    );
};

export default VulnerabilityScanner;
