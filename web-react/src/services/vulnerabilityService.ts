import { api } from './api';

export interface Vulnerability {
  id: string;
  cve_id: string;
  title: string;
  description: string;
  severity: 'critical' | 'high' | 'medium' | 'low';
  cvss_score: number;
  published_date: string;
  last_modified: string;
  affected_software: string[];
  status: 'open' | 'in_progress' | 'resolved' | 'false_positive';
  asset_id: string;
  asset_name: string;
  remediation: string;
  references: string[];
}

export interface VulnerabilityStats {
  total: number;
  critical: number;
  high: number;
  medium: number;
  low: number;
  resolved: number;
  open: number;
  in_progress: number;
}

export interface VulnerabilityResponse {
  success: boolean;
  data: Vulnerability[];
  message?: string;
  timestamp?: string;
}

export const vulnerabilityService = {
  async getVulnerabilities(): Promise<Vulnerability[]> {
    try {
      const response = await api.get<VulnerabilityResponse>('/api/vulnerabilities/');
      return response.data.data || [];
    } catch (error) {
      console.error('Failed to fetch vulnerabilities:', error);
      return [];
    }
  },

  async getVulnerability(id: string): Promise<Vulnerability | null> {
    try {
      const response = await api.get<{ success: boolean; data: Vulnerability }>(`/api/vulnerabilities/${id}`);
      return response.data.data || null;
    } catch (error) {
      console.error('Failed to fetch vulnerability:', error);
      return null;
    }
  },

  async getVulnerabilityStats(): Promise<VulnerabilityStats> {
    try {
      const vulnerabilities = await this.getVulnerabilities();
      
      return {
        total: vulnerabilities.length,
        critical: vulnerabilities.filter(v => v.severity === 'critical').length,
        high: vulnerabilities.filter(v => v.severity === 'high').length,
        medium: vulnerabilities.filter(v => v.severity === 'medium').length,
        low: vulnerabilities.filter(v => v.severity === 'low').length,
        resolved: vulnerabilities.filter(v => v.status === 'resolved').length,
        open: vulnerabilities.filter(v => v.status === 'open').length,
        in_progress: vulnerabilities.filter(v => v.status === 'in_progress').length,
      };
    } catch (error) {
      console.error('Failed to fetch vulnerability stats:', error);
      return {
        total: 0,
        critical: 0,
        high: 0,
        medium: 0,
        low: 0,
        resolved: 0,
        open: 0,
        in_progress: 0,
      };
    }
  },

  async updateVulnerabilityStatus(id: string, status: Vulnerability['status']): Promise<boolean> {
    try {
      const response = await api.patch(`/api/vulnerabilities/${id}/status`, { status });
      return response.status === 200 || response.status === 204;
    } catch (error) {
      console.error('Failed to update vulnerability status:', error);
      throw error;
    }
  },
};

