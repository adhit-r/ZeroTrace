#!/bin/bash
# Monitor CVE download progress

LOG_FILE="/tmp/cve_full_download.log"

if [ ! -f "$LOG_FILE" ]; then
    echo "ERROR: Log file not found: $LOG_FILE"
    echo "   Download may not be running"
    exit 1
fi

echo "CVE Download Progress Monitor"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# Check if process is running
PID=$(pgrep -f "update_cve_data.py --force-full")
if [ -z "$PID" ]; then
    echo "WARNING: Download process not found (may have completed or failed)"
else
    echo "OK: Download process running (PID: $PID)"
fi

echo ""
echo "Recent Progress:"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
tail -20 "$LOG_FILE" | grep -E "Fetched|Total|Progress|ERROR|rate limit" | tail -10

echo ""
echo "Current Status:"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

# Extract latest progress
LATEST=$(tail -50 "$LOG_FILE" | grep -E "Fetched.*total:" | tail -1)
if [ -n "$LATEST" ]; then
    echo "$LATEST"
else
    echo "No progress data yet..."
fi

echo ""
echo "Commands:"
echo "   - Watch live: tail -f $LOG_FILE"
echo "   - Check errors: grep ERROR $LOG_FILE | tail -10"
echo "   - Stop download: pkill -f 'update_cve_data.py'"

